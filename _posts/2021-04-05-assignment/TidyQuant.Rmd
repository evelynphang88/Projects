---
title: "Stock Analysis - Visualisations for Stock Performance"
author: "EvelynPhang"
date: "4/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r }
setwd("C:/Users/User/Google Drive/MITB Files/Course Info/10 Visual Analytics/DistillBlog/Projects/_posts/2021-04-05-assignment")
```

Background

For the course ISSS608- Visual Analytics, my project group we would like to product a SHINY APP - that provides various tools for a Financial Analysts or even Beginner investor, to analyse stocks past performance and forecasting. 

The final project has 3 parts : 
1)Forecasting ( leveraging ModelTime pcakge) 
2)Visualisations for Stock Performance ( leveraging TidyQuant Package) 
3)Extensive Time Series analysis ( leveraging TimeTK)  

This report coverage the exploration of part 2 - Plots and Graphs as prep for the final project.

### 1. Overview and Purpose of Dataviz Assignment

Many investors analyze stocks based on their fundamentals – such as their revenue, valuation, or industry trends – but fundamental factors aren't always reflected in the market price. Technical analysis seeks to predict price movements by examining historical data, mainly price and volume. Technical analysis using charts help to identify trading signals and price patterns, and provides as a window into market psychology to identify opportunities to profit.

After some research, the following 4 charts provide the most information for the beginner trader to study a single stock:

1) Price Movement - Candlesticks Chart 
THis chart reflect the impact of investor sentiment on security prices and are used by technical analysts to determine when to enter and exit trades. 

2) Stock Price and Trading Volume - Line Charts/Bart Charts
it’s good to know what the volumes have been in the past and what they are currently before making a decision.

3) Moving averages (15-day, 50-day and 200-day) on a particular stock price movement- where
Liquid/Volatile stocks may benefit from shorter (eg.15-day) moving average analysis where as illiquid stocks my be examined with 50-day moving average

4) Charting on Different Time Frames
The technical analysis time frames shown on charts range from one-minute to monthly, or even yearly, time spans. Popular time frames that technical analysts most frequently examine include:
-5-minute chart
-15-minute chart
-Hourly chart
-4-hour chart
-Daily chart

After some research, the typical two charts that is useful for a trader to analysis his portfolio are :

5)Portfolio Returns Chart- chart to view for different combination stocks what wuld have bee the total resturns in the past.

6)Risk vs Rewards - for a chosen combination of stocks.


### 2. TidyQuant ( Tidy Quantitative Financial Analysis) Package Exploration for  - Stock visualisation.

#### 2.1 TidyQuant Single Stock Analysis

The tidyquant package includes charting tools to assist users in developing quick visualizations in ggplot2 using the grammar of graphics format and workflow.  

The 'tidyquant' package provides a convenient wrapper to various package functions:'xts','zoo''quantmod', 'TTR' and 'PerformanceAnalytics' package functions and returns the objects in the tidy 'tibble' format. The main advantage is being able to use quantitative functions with the 'tidyverse' functions including 'purrr', 'dplyr', 'tidyr', 'ggplot2', 'lubridate', etc.

There are three primary geometry (geom) categories and one coordinate manipulation (coord) category within tidyquant.


1)Candlestick
Chart type visualizations for Candlestick is implemented using  geom_candlestick.

2)Moving Averages Chart Types: 
      Seven moving average visualizations are available using geom_ma.
      Bollinger Bands: Bollinger bands can be visualized using geom_bbands. 

3)Charting on different time zones
Zooming in on Date Ranges: Two coord functions are available (coord_x_date and coord_x_datetime), which prevent data loss when zooming in on specific regions of a chart. 


```{r}
# Loads tidyquant, lubridate, xts, quantmod, TTR, and PerformanceAnalytics

packages <- c('tidyverse','tidyquant','lubridate','xts','quantmod','TTR','PerformanceAnalytics')

for (p in packages){
  if (!require(p,character.only=T)){
    install.packages(p)
  }
  library(p, character.only=T)
}

```


#### 2.2 TidyQuant for Portfolio Analysis

Financial asset (individual stocks, securities, etc) and portfolio (groups of stocks, securities, etc) performance analysis is a deep field with a wide range of theories and methods for analyzing risk versus reward. The PerformanceAnalytics package consolidates functions to compute many of the most widely used performance metrics. tidquant integrates this functionality so it can be used at scale using the split, apply, combine framework within the tidyverse. 

Two primary functions integrate the performance analysis functionality:

tq_performance 

implements the performance analysis functions in a tidy way, enabling scaling analysis using the split, apply, combine framework.

tq_portfolio 

provides a useful tool set for aggregating a group of individual asset returns into one or many portfolios.


### 3. Loading and Preping Data 

Tidyquant provides a function tq_get for directly loading data. For the purpose of this assignment i use this funciton to get the data for APPLE, AMAZON, FACEBOOK< GOOGLE, NETFLIX. To preapre for a multi-stock analysis evaluation, i also built combined data set.


```{r}
AAPL <- tq_get("AAPL", get = "stock.prices", from = "2011-01-01", to = "2021-03-31")
AMZN <- tq_get("AMZN", get = "stock.prices", from = "2011-01-01", to = "2021-03-31")
GOOG <- tq_get("GOOG",get = "stock.prices", from = "2011-01-01", to = "2021-03-31")
NFLX <- tq_get("NFLX",get = "stock.prices", from = "2011-01-01", to = "2021-03-31")
FB <- tq_get("FB",get = "stock.prices", from = "2011-01-01", to = "2021-03-31")
```


```{r}
FAANG<- rbind(FB,AAPL,AMZN,NFLX,GOOG)
```

Setup the End Data for review as last day in March of 2021

```{r}
end <- as_date("2021-03-31")
```

### 4.Testing and Prototyping -  Single Stock Analysis ( using the popular APPLE stock)


#### 4.1 Price Movement Candlestick Chart

#### 4.1.1 Charting the complete data series


```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Candlestick Chart", y = "Closing Price", x = "") +
    scale_color_tq(theme = "dark") +
    scale_y_continuous(labels = scales::dollar)
```
#### 4.1.2 Zooming into a 6 week window.

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Candlestick Chart", 
         subtitle = "Zoomed in using coord_x_date",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(6), end),
                 ylim = c(110, 140)) + 
    theme_tq_dark() +
    scale_color_tq(theme = "dark") +
    scale_y_continuous(labels = scales::dollar)
```

#### 4.1.3 Zooming into 1 week

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Candlestick Chart", 
         subtitle = "Zoomed in using coord_x_date",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(1), end),
                 ylim = c(115, 130)) + 
    theme_tq() +
    scale_color_tq(theme = "dark") +
    scale_y_continuous(labels = scales::dollar)
```


### 4.1.3  Using different colours for the candlesticks.
 
The colors can be modified using colour_up and colour_down, which control the line color, and fill_up and fill_down, which control the rectangle fills.Using RED and GREEN - makes it very clear for the user.. which is the 'danger' candlestick.

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close),
                        colour_up = "darkgreen", colour_down = "darkred", 
                        fill_up  = "darkgreen", fill_down  = "darkred") +
    labs(title = "AAPL Candlestick Chart- 6 weeks ", 
         subtitle = "Zoomed in, Experimenting with Formatting",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(6), end),
                 ylim = c(110, 140)) + 
    theme_tq()
```



4.1.2 Stock Price and Trading Volume - Line Charts/Bart Charts

#### 4.1.2.1 Line Chart

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_line() +
    labs(title = "AAPL Line Chart- Prices", y = "Closing Price USD", x = "") +
    theme_tq()
```
#### 4.1.2.1 Bar Chart- for the full period
```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_barchart(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Bar Chart -Stock Prices", y = "Closing Price", x = "") + 
    theme_tq()
```

#### 4.1.2.1 Bar Chart- for 6 weeks - zoomed in


```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_barchart(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Bar Chart of Stock Prices", 
         subtitle = "Zoomed in using coord_x_date",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(6), end),
                 ylim = c(100, 150)) + 
     theme_tq()
```


#### 4.1.2.3 Volume Chart - using Geom_segment

We can use the geom_segment() function to chart daily volume, which uses xy points for the beginning and end of the line. Using the aesthetic color argument, we color based on the value of volume to make these data stick out.


```{r}
AAPL %>%
    ggplot(aes(x = date, y = volume)) +
    geom_segment(aes(xend = date, yend = 0, color = volume)) + 
    geom_smooth(method = "loess", se = FALSE) +
    labs(title = "APPLE Volume Chart for the whole period", 
         subtitle = "Charting Daily Volume", 
         y = "Volume", x = "") +
    theme_tq() +
    theme(legend.position = "none") 
```



4.1.2.3 Volume Chart - using Geom_segment- zoomed in 

And, we can zoom in on a specific region. Using scale_color_gradient we can quickly visualize the high and low points, and using geom_smooth we can see the trend.

```{r}
start <- end - weeks(24)
AAPL %>%
    filter(date >= start - days(50)) %>%
    ggplot(aes(x = date, y = volume)) +
    geom_segment(aes(xend = date, yend = 0, color = volume)) +
    geom_smooth(method = "loess", se = FALSE) +
    labs(title = "APPLE STOCK Bar Chart", 
         subtitle = "Charting Daily Volume, Zooming In", 
         y = "Volume", x = "") + 
    coord_x_date(xlim = c(start, end)) +
    scale_color_gradient(low = "red", high = "darkblue") +
    theme_tq() + 
    theme(legend.position = "none")
```


4.1.3 Moving Averages


Visualizing Trends averages are critical to evaluating time-series trends. Tidyquant includes geoms to enable “rapid prototyping” to quickly visualize signals using moving averages and Bollinger bands.


Within Tidyquant the following moving averages are available:
1)Simple moving averages (SMA)
2)Exponential moving averages (EMA)
3)Weighted moving averages (WMA)
4)Double exponential moving averages (DEMA)
5)Zero-lag exponential moving averages (ZLEMA)
6)Volume-weighted moving averages (VWMA) (also known as VWAP)
7)Elastic, volume-weighted moving averages (EVWMA) (also known as MVWAP)

For the purpose of this assignment i will look at SMA


4.1.3.1 Charting the 14-day,50-day and 200-day simple moving average

Charting the 50-day and 200-day simple moving average using the SMA funciton as an example.
We apply the moving average geoms after the candlestick geom to overlay the moving averages on top of the candlesticks. We add two moving average calls, one for the 50-day and the other for the 200-day. We add color = "red" and linetype = 5 to distinguish the 200-day from the 50-day.

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    geom_ma(ma_fun = SMA, n = 14, color= 'green', size = 1.25) +
    geom_ma(ma_fun = SMA, n = 50, color= 'blue', size = 1.25) +
    geom_ma(ma_fun = SMA, n = 200, color = "red", size = 1.25) + 
    labs(title = "AAPL Candlestick Chart", 
         subtitle = "14-Day SMA(green),50-Day SMA(blue) and 200-DaySMA (red )", 
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(24), end),
                 ylim = c(80, 160)) + 
    theme_tq()
```

#### 4.1.4 Charting for Reviewing Stock Volatility - Bolingar Bands

Bollinger Bands are used to visualize volatility by plotting a range around a moving average typically two standard deviations up and down. Because they use a moving average, the geom_bbands function works almost identically to geom_ma. The same seven moving averages are compatible. The main difference is the addition of the standard deviation, sd, argument which is 2 by default, and the high, low and close aesthetics which are required to calculate the bands. 

#### 4.1.4.1

Applying BBands using a SMA

```{r}
AAPL %>%
    ggplot(aes(x = date, y = close, open = open,
               high = high, low = low, close = close)) +
    geom_candlestick() +
    geom_bbands(ma_fun = SMA, sd = 2, n = 20) +
    labs(title = "AAPL Candlestick Chart", 
         subtitle = "BBands with SMA Applied", 
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(24), end),
                 ylim = c(80, 160)) + 
    theme_tq()
```

Modifying the appearance of Bollinger Bands

```{r}

AAPL %>%
    ggplot(aes(x = date, y = close, open = open,
               high = high, low = low, close = close)) +
    geom_candlestick() +
    geom_bbands(ma_fun = SMA, sd = 2, n = 20, 
                linetype = 4, size = 1, alpha = 0.2, 
                fill        = palette_light()[[1]], 
                color_bands = palette_light()[[1]], 
                color_ma    = palette_light()[[2]]) +
    labs(title = "AAPL Candlestick Chart", 
         subtitle = "BBands with SMA Applied, Experimenting with Formatting", 
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(end - weeks(24), end),
                 ylim = c(80, 160)) + 
    theme_tq()

```



### 4.2 Charting for Multiple Securities

Charting Multiple Securities- We can use facet_wrap to visualize multiple stocks at the same time. By adding a group aesthetic in the main ggplot() function and combining with a facet_wrap() function at the end of the ggplot workflow, all four “FANG” stocks can be viewed simultaneously. You may notice an odd filter() call before the call to ggplot(). I’ll discuss this next.

To do this exploration, we will use the summarised dataset FAANG , prepared earlier.

4.2.1 Multiple securities -Closing prices


```{r}
start <- end - weeks(6)
```

```{r}
FAANG %>%
    filter(date >= start - days(2 * 15)) %>%
    ggplot(aes(x = date, y = close, group = symbol)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "FAANG Candlestick Chart", 
         subtitle = "Experimenting with Mulitple Stocks",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(start, end)) +
    facet_wrap(~ symbol, ncol = 2, scale = "free_y") + 
    theme_tq()
```
4.2.2 Multiple securities -Moving averages for multiple stocks at once

We’ll double up using a volume-weighted average (VWMA) and apply it to the FAANG stocks at once. 

Since VWMA is a volume-weighted function, we need to add volume as an aesthetic. 

Because we are viewing multiple stocks, we add a group aesthetic setting it to the symbol column which contains the FAANG stock symbols. 

The facet wrap is added at the end to create five charts.


```{r}
start <- end - weeks(6)

FAANG %>%
    filter(date >= start - days(2 * 50)) %>%
    ggplot(aes(x = date, y = close, volume = volume, group = symbol)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    geom_ma(ma_fun = VWMA, n = 15, wilder = TRUE, linetype = 5) +
    geom_ma(ma_fun = VWMA, n = 50, wilder = TRUE, color = "red") + 
    labs(title = "FAANG Bar Chart", 
         subtitle = "50 and 200-Day EMA, Experimenting with Multiple Stocks", 
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(start, end)) +
    facet_wrap(~ symbol, ncol = 2, scales = "free_y") + 
    theme_tq()
```

4.2.3  Multiple securities -BBands to multiple stocks


```{r}
start <- end - weeks(24)
FAANG %>%
    filter(date >= start - days(2 * 20)) %>%
    ggplot(aes(x = date, y = close, 
               open = open, high = high, low = low, close = close, 
               group = symbol)) +
    geom_barchart() +
    geom_bbands(ma_fun = SMA, sd = 2, n = 20, linetype = 5) +
    labs(title = "FANG Bar Chart", 
         subtitle = "BBands with SMA Applied, Experimenting with Multiple Stocks", 
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(start, end)) +
    facet_wrap(~ symbol, ncol = 2, scales = "free_y") + 
    theme_tq()
```
4.3. ggplot2 Functionality - for analyzing Financial Data

4.3.1 Log Scale with : ggplot2 : scale_y_log10 function

4.3.2 Regression trendlines with : ggplot2 : geom_smooth

4.3.3 Charting volume with geom_segment


### 5.0 Three Major Advantages of Incorporating Interactivity


### References

https://www.moneyunder30.com/how-to-read-a-stock-chart

